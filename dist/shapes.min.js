const randomHex=()=>Math.round(255*Math.random());class Mouse{#e;#t;#s;#r;#i=[];constructor(e){const t=document.getElementById(e);t.addEventListener("mousedown",this.handleMouseDown),t.addEventListener("mousemove",this.handleMouseMove),t.addEventListener("mouseup",this.handleMouseUp)}addListener(e){this.#i.find((t=>t==e))||this.#i.push(e)}removeListener(e){for(let t=0;t<this.#i.length;t++)if(this.#i[t]==e){this.#i.splice(t,1);break}}handleMouseUp=e=>{for(let e of this.#i)e.name?.toLowerCase().includes("mouseup")&&e.call(root)};handleMouseMove=e=>{this.#e=e.offsetX,this.#t=e.offsetY;for(let e of this.#i)e.name?.toLowerCase().includes("mousemove")&&e.call(root)};handleMouseDown=e=>{this.#s=e.offsetX,this.#r=e.offsetY;for(let e of this.#i)e.name?.toLowerCase().includes("mousedown")&&e.call(root)};getX(){return this.#e}getY(){return this.#t}getDragPrevX(){return this.#s}getDragPrevY(){return this.#r}getDragOffset(){return{x:this.getX()-this.getDragPrevX(),y:this.getY()-this.getDragPrevY()}}}class Keyboard{#i=[];#a;#h=!1;constructor(){document.addEventListener("keydown",this.handleKeyDown)}addListener(e){this.#i.find((t=>t==e))||this.#i.push(e)}removeListener(e){for(let t=0;t<this.#i.length;t++)if(this.#i[t]==e){this.#i.splice(t,1);break}}getKey(){return this.#a}getCtrlKey(){return this.#h}handleKeyDown=e=>{this.#a=e.key,this.#h=e.ctrlKey;for(let e of this.#i)e.name?.toLowerCase().includes("keydown")&&e.call(root)}}const line=(e,t,{close:s,fill:r,fillColor:i,lineWidth:a})=>{ctx.lineWidth=a||1,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(e[0],e[1]);for(let e=0;e<t.length;e+=2)ctx.lineTo(t[e],t[e+1]);s&&ctx.closePath(),ctx.strokeStyle="rgb(255,10,10)",r&&(ctx.fillStyle=i),r?ctx.fill():ctx.stroke()},curve=(e,t,{close:s,fill:r,fillColor:i})=>{ctx.lineWidth=1,ctx.lineCap="round",ctx.beginPath(),ctx.moveTo(e[0],e[1]);for(let e=0;e<t.length;e+=4)ctx.quadraticCurveTo(t[e],t[e+1],t[e+2],t[e+3]);s&&ctx.closePath(),r&&(ctx.fillStyle=i),r?ctx.fill():ctx.stroke()},triangle=(e,t,s,r,i)=>{line([e,t],[e+r,t+s,e-r,t+s],i)},box=(e,t,s,r,i)=>{line([e,t],[e+r,t,e+r,t+s,e,t+s],i)},circle=(e,t,s)=>{ctx.beginPath(),ctx.lineWidth=1,ctx.fillColor="rgba(25, 120, 164, 1)",ctx.arc(e,t,s,0,2*Math.PI),ctx.fill()},arc=(e,t,s,r,i,a)=>{ctx.beginPath();i&&(ctx.fillStyle=a),ctx.ellipse(e,t,s,r,0,3,10),i?ctx.fill():ctx.stroke()},getCurrentShapeIndex=(e,t,s)=>e.findLastIndex(((e,r)=>{const i=e.getShapeProps();let a=!1,h=!1;return e instanceof Box?(a=i.width>0?t>=i.x&&t<=i.x+i.width:t<=i.x&&t>=i.x+i.width,h=i.height>0?s>=i.y&&s<=i.y+i.height:s<=i.y&&s>=i.y+i.height):e instanceof Triangle?(a=i.width>0?t>=i.x-i.width&&t<=i.x+i.width:t<=i.x-i.width&&t>=i.x+i.width,h=i.height>0?s>=i.y&&s<=i.y+i.height:s<=i.y&&s>=i.y+i.height):e instanceof Arc?(a=t>=i.prevX-i.radius&&t<=i.prevX+i.radius,h=s>=i.prevY-i.radius&&s<=i.prevY+i.radius):e instanceof Line&&(a=i.x1>i.x?t>=i.x&&t<=i.x1:t>=i.x1&&t<=i.x,h=i.y1>i.y?s>=i.y&&s<=i.y1:s>=i.y1&&s<=i.y),a&&h})),shapesFactory={circle:circle,triangle:triangle,box:box,line:line,curve:curve},ShapeUtils={getCurrentShapeIndex:getCurrentShapeIndex};class Shape{#o;#n=!1;#p=!1;#l=0;#c=0;static#g="";static#u=-1;static#d=[];static#S=[];constructor(e){this.#o=e,e||(mouse.addListener(this.handleMouseDown),mouse.addListener(this.handleMouseMove),mouse.addListener(this.handleMouseUp),keyboard.addListener(this.handleKeyDown))}handleKeyDown(){const e=keyboard.getKey(),t=keyboard.getCtrlKey();if(t){if("z"==e.toLowerCase()){const e=this.removeShape();e&&Shape.#S.push(e),requestAnimationFrame((e=>this.draw(e)))}if("y"==e.toLowerCase()){const e=Shape.#S.pop();e&&this.addShape(e),requestAnimationFrame((e=>this.draw(e)))}if("v"==e.toLowerCase()){const e=this.getShape(Shape.#u);e&&this.addShape(this.copyShape(e)),requestAnimationFrame((e=>this.draw(e)))}}"d"==e.toLowerCase()?this.#p=!0:t&&"v"==e.toLowerCase()||(this.#p=!1),"b"==e.toLowerCase()?Shape.#g="box":"t"==e.toLowerCase()?Shape.#g="triangle":"c"==e.toLowerCase()?Shape.#g="circle":"l"==e.toLowerCase()?Shape.#g="line":"p"==e.toLowerCase()?Shape.#g="pencil":Shape.#g=""}handleMouseUp(){if(!this.#p&&""!=Shape.#g){const e=this.getShape(this.getShapes().length-1);if(this.#l==mouse.getX()&&this.#c==mouse.getY()||e&&0==e.getShapeProps().height||0==e.getShapeProps().width)this.removeShape();else if("pencil"==e.getShape()){const e=this.removeShape();let t=e.getShapeProps().allPoints,s=[];for(let e=0;e<t.length;e+=4)s.push(t[e],t[e+1]);e.setShapeProps({allPoints:JSON.parse(JSON.stringify(s))}),this.addShape(e),requestAnimationFrame((e=>this.draw(e)))}this.#l=0,this.#c=0}this.#n=!1}handleMouseMove(){const e=mouse.getX()-this.#l,t=mouse.getY()-this.#c;if(this.#n){if(!this.#p&&""!=Shape.#g){const s=this.getShape(this.getShapes().length-1);if("circle"==Shape.#g)s.setShapeProps({...s.getShapeProps(),x:mouse.getX(),y:mouse.getY(),radiusX:Math.abs(mouse.getX()-this.#l),radiusY:Math.abs(mouse.getY()-this.#c)});else if("line"==Shape.#g)s.setShapeProps({...s.getShapeProps(),x1:mouse.getX(),y1:mouse.getY()});else if("pencil"==Shape.#g){const e=s.getShapeProps().allPoints;s.setShapeProps({allPoints:e.concat([mouse.getX(),mouse.getY()])})}else s.setShapeProps({...s.getShapeProps(),height:t,width:e});requestAnimationFrame((e=>this.draw(e)))}if(this.#p&&-1!==Shape.#u){const s=this.getShape(Shape.#u),r=s.getShapeProps();s instanceof Arc?s.setShapeProps({...r,prevX:r.prevX+e,prevY:r.prevY+t}):s instanceof Line?s.setShapeProps({x1:r.x1+e,y1:r.y1+t,x:r.x+e,y:r.y+t}):s.setShapeProps({...r,x:r.x+e,y:r.y+t}),requestAnimationFrame((e=>this.draw(e))),this.#l=mouse.getX(),this.#c=mouse.getY()}}requestAnimationFrame((e=>this.draw(e)))}handleMouseDown(){if(this.#l=mouse.getDragPrevX(),this.#c=mouse.getDragPrevY(),requestAnimationFrame((e=>this.draw(e))),Shape.#u=ShapeUtils.getCurrentShapeIndex(this.getShapes(),this.#l,this.#c),this.#n=!0,!this.#p){const e=`rgb(${randomHex()},${randomHex()},${randomHex()})`;"box"==Shape.#g?this.addShape(new Box({x:mouse.getX(),y:mouse.getY(),height:0,width:0,close:!0,fill:!0,fillColor:e})):"triangle"==Shape.#g?this.addShape(new Triangle({x:mouse.getX(),y:mouse.getY(),height:0,width:0,close:!0,fill:!0,fillColor:e})):"circle"==Shape.#g?this.addShape(new Arc({x:mouse.getX(),y:mouse.getY(),prevX:this.#l,prevY:this.#c,radiusY:Math.abs(mouse.getY()-this.#c),radiusX:Math.abs(mouse.getX()-this.#l),fill:!0,fillColor:e})):"line"==Shape.#g?this.addShape(new Line({x1:mouse.getX(),y1:mouse.getY(),x:this.#l,y:this.#c})):"pencil"==Shape.#g&&this.addShape(new Pencil({allPoints:[mouse.getX(),mouse.getY()]}))}}draw(e){ctx.setTransform(1,0,0,1,0,0),ctx.clearRect(0,0,canvas.width,canvas.height);const t=this.getShapes(),s=this.getShape(Shape.#u);for(const e of t)e.draw();-1!=Shape.#u&&this.getShapes().length>0&&s.showBounds(),line([mouse.getX()-10,mouse.getY()],[mouse.getX()+10,mouse.getY()],{close:!1,lineWidth:2}),line([mouse.getX(),mouse.getY()-10],[mouse.getX(),mouse.getY()+10],{close:!1,lineWidth:2})}getIsDrawing(){return this.#n}setIsDrawing(e){this.#n=e}getIsMoving(){return this.#p}setIsMoving(e){this.#p=e}getShapeProps(){return this.#o}setShapeProps(e){this.#o=e}getShapes(){return Shape.#d}getShape(e){return Shape.#d[e]}addShape(e){Shape.#d.push(e)}removeShape(){return Shape.#d.pop()}copyShape(e){return new e.constructor(e.getShapeProps())}}class Box extends Shape{constructor(e){super(e)}draw(){const{x:e,y:t,width:s,height:r,...i}=this.getShapeProps();line([e,t],[e+s,t,e+s,t+r,e,t+r],i)}getShape(){return"box"}showBounds(){const{x:e,y:t,width:s,height:r}=this.getShapeProps();shapesFactory.circle(e,t,5),shapesFactory.circle(e+s,t+r,5),shapesFactory.circle(e,t+r,5),shapesFactory.circle(e+s,t,5),shapesFactory.line([e,t],[e+s,t,e+s,t+r,e,t+r],{close:!0})}}class Triangle extends Shape{constructor(e){super(e)}draw(){const{x:e,y:t,width:s,height:r,...i}=this.getShapeProps();triangle(e,t,r,s,i)}getShape(){return"triangle"}showBounds(){const{x:e,y:t,width:s,height:r}=this.getShapeProps();shapesFactory.circle(e-s,t,5),shapesFactory.circle(e+s,t+r,5),shapesFactory.circle(e-s,t+r,5),shapesFactory.circle(e+s,t,5),shapesFactory.line([e-s,t],[e+s,t,e+s,t+r,e-s,t+r],{close:!0})}}class Arc extends Shape{constructor(e){super(e)}draw(){const{radiusX:e,radiusY:t,prevX:s,prevY:r,fill:i,fillColor:a}=this.getShapeProps();arc(s,r,e,t,i,a)}getShape(){return"circle"}showBounds(){const{radius:e,prevX:t,prevY:s}=this.getShapeProps();shapesFactory.circle(t-e,s-e,5),shapesFactory.circle(t+e,s-e,5),shapesFactory.circle(t-e,s+e,5),shapesFactory.circle(t+e,s+e,5),shapesFactory.line([t-e,s-e],[t+e,s-e,t+e,s+e,t-e,s+e],{close:!0})}}class Line extends Shape{constructor(e){super(e)}draw(){const{x:e,y:t,x1:s,y1:r}=this.getShapeProps();shapesFactory.line([e,t],[s,r],{close:!1,fill:!1})}getShape(){return"line"}showBounds(){const{x:e,y:t,x1:s,y1:r}=this.getShapeProps();shapesFactory.circle(e,t,5),shapesFactory.circle(s,r,5),shapesFactory.line([e,t],[s,r],{close:!1})}}class Pencil extends Shape{constructor(e){super(e)}draw(){const{allPoints:e}=this.getShapeProps();shapesFactory.curve([e[0],e[1]],e,{close:!1,fill:!1})}getShape(){return"pencil"}showBounds(){}}